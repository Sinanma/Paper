---
title: "My title"
subtitle: "My subtitle if needed"
author: 
  - First author
  - Another author
thanks: "Code and data are available at: LINK."
date: 12 March, 2024
date-format: long
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
format: pdf
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

####workspcae setup####

library(tidyverse)
library(here)
library(rstanarm)
library(modelsummary)
library(knitr)
library(dplyr)
library(tibble)
```

```{r}
#| include: false

#### import data ####
toronto_shelters_clean <- read_csv(here::here("data/analysis_data/analysis_data.csv"))
```


# Introduction


# Data {#sec-data}




```{r}
#| label: fig-torontoo
#| fig-cap: "Toronto shelter rooms average usage in 2022"
#| echo: false

toronto_shelters_clean |> 
 mutate(occupancy_month = month(occupancy_date, 
                                label = TRUE,
                                abbr = FALSE)) |>
  arrange(month(occupancy_date)) |>
  drop_na(occupied_rooms) |> 
  summarise(avgs_of_rooms_occupied = mean(occupied_rooms),
             .by = occupancy_month) |>
  ggplot(aes(x= occupancy_month, y = avgs_of_rooms_occupied)) + geom_point()
```

```{r}
#| label: tbl-torontoo
#| tbl-cap: "Shelter usage in Toronto in 2022"
#| echo: false
  toronto_shelters_clean |>
  mutate(occupancy_month = month(
    occupancy_date,
    label = TRUE,
    abbr = FALSE
  )) |>
  arrange(month(occupancy_date)) |> 
  drop_na(occupied_rooms) |>
  summarise(number_occupied = mean(occupied_rooms),
            .by = occupancy_month) |>
  kable(
    col.names = c("Month", "Avg daily occupied rooms"),
    digits = 1
  )
```


```{r}
#| label: fig-city
#| fig-cap: "The shelter rooms usage based on different sector and city in Toronto"
#| echo: false
#| warning: false
#| message: false
toronto_shelters_clean |>
  drop_na(occupied_rooms, sector, location_city) |>
  ggplot(aes(x = location_city, y = occupied_rooms, color = sector)) +
  geom_point() +
  theme_minimal() +
  labs(x = "location_city", y = "occupied_rooms", color = "Sector") +
  scale_color_brewer(palette = "Set1") +
  theme(legend.position = "bottom")
```

```{r}
#| label: fig-programs
#| fig-cap: "The shelter rooms usage based on different sector and services program inn Toronto."
#| echo: false
#| warning: false
#| message: false
toronto_shelters_clean |>
  drop_na(location_city) |>
  ggplot(mapping = aes(x = location_city, fill = sector)) +
  geom_bar() +
  theme_linedraw() +
  labs(x = "location_city",y = "num_occupied_rooms",fill = "sector") +
  facet_wrap(vars(program_model), scales = "free") +
  guides(x = guide_axis(angle = 60)) +
  theme(legend.position = "bottom") + 
  scale_fill_viridis_d(option = "magma")
```

Talk more about it.

 (You can change the height and width, but don't worry about doing that until you have finished every other aspect of the paper - Quarto will try to make it look nice and the defaults usually work well once you have enough text.)



Talk way more about it. 



# Model

The goal of our modelling strategy is twofold. Firstly,...

Here we briefly describe the Bayesian analysis model used to investigate... Background details and diagnostics are included in.

## Model set-up

Define $y_i$ as the number of seconds that the plane remained aloft. Then $\beta_i$ is the wing width and $\gamma_i$ is the wing length, both measured in millimeters.  

\begin{align} 
y_i|\mu_i, \sigma &\sim \mbox{Normal}(\mu_i, \sigma) \\
\mu_i &= \alpha + \beta_i + \gamma_i\\
\alpha &\sim \mbox{Normal}(0, 2.5) \\
\beta &\sim \mbox{Normal}(0, 2.5) \\
\gamma &\sim \mbox{Normal}(0, 2.5) \\
\sigma &\sim \mbox{Exponential}(1)
\end{align}



### Model justification

We expect a positive relationship between the size of the wings and time spent aloft. In particular...

We can use maths by including latex between dollar signs, for instance $\theta$.


# Results

Our results are summarized in @tbl-modelresults.

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

toronto_shelters_data_first_model_rstanarm <-
  readRDS(file = here::here("models/shelters_data_model_one_rstanarm.rds"))
```


```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

prior_summary(toronto_shelters_data_first_model_rstanarm)
```

```{r}
#| label: fig-models
#| fig-cap: "The relationship between the occupancy rate and actual room occupied."  
#| echo: false
#| warning: false
#| message: false
draws <- 1000

occupancy_rate_rooms <- runif(n = draws * 16, min = 0.5, max = 1.5)

toronto_shelters_clean <-
  tibble(
    sigma = rep(rexp(n = draws, rate = 1), times = 16),
    beta_0 = rep(rnorm(n = draws, mean = 0, sd = 2.5), times = 16),
    beta_1 = rep(rnorm(n = draws, mean = 8, sd = 2.5), times = 16),
    five_km_time = rep(15:30, each = draws),
    occupancy_rate_rooms = occupancy_rate_rooms, 
    mu = beta_0 + beta_1 * occupancy_rate_rooms
  ) |>
  rowwise() |>
  mutate(
    capacity_actual_room = rnorm(n = 1, mean = mu, sd = sigma)
  )

toronto_shelters_clean |>
  ggplot(aes(x = occupancy_rate_rooms, y = capacity_actual_room)) +
  geom_point(alpha = 0.1) +
  theme_classic()
```


```{r}
#| echo: false
#| eval: true
#| label: tbl-modelresults
#| tbl-cap: "Explanatory models of Toronto's shelters usage based on occupancy rate  and service user count"
#| warning: false

modelsummary(toronto_shelters_data_first_model_rstanarm)
```




# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this. 

## Second discussion point

## Third discussion point

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {-}


# Additional data details

# Model details {#sec-model-details}

## Posterior predictive check

we implement a posterior predictive check. This shows...
we compare the posterior with the prior. This shows... 

```{r}
#| eval: true
#| echo: false
#| message: false
#| warning: false
#| label: fig-ppcheckandposteriorvsprior
#| layout-ncol: 2
#| fig-cap: "Examining how the model fits, and is affected by, the data"
#| fig-subcap: ["Posterior prediction check", "Comparing the posterior with the prior"]

pp_check(toronto_shelters_data_first_model_rstanarm) +
  theme_classic() +
  theme(legend.position = "bottom")

posterior_vs_prior(toronto_shelters_data_first_model_rstanarm) +
  theme_minimal() +
  scale_color_brewer(palette = "Set1") +
  theme(legend.position = "bottom") +
  coord_flip()
```

## Diagnostics

is a trace plot. It shows... This suggests...

is a Rhat plot. It shows... This suggests...

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-stanareyouokay
#| fig-cap: "Checking the convergence of the MCMC algorithm"
#| fig-subcap: ["Trace plot", "Rhat plot"]
#| layout-ncol: 2

plot(toronto_shelters_data_first_model_rstanarm, "trace")

plot(toronto_shelters_data_first_model_rstanarm, "rhat")
```



\newpage


# References


